sudo: required
language: java
jdk:
  - openjdk11
services:
  - docker
before_install:
  - openssl aes-256-cbc -K $encrypted_4bc2f511cfb7_key -iv $encrypted_4bc2f511cfb7_iv
    -in travis/helseci.key.enc -out travis/helseci.key -d
  - git clone https://github.com/navikt/github-apps-support.git
  - export PATH=`pwd`/github-apps-support/bin:$PATH
  - export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
    $GITHUB_APP_ID`)
  - export COMMIT_SHORT=$(git rev-parse --short HEAD)
  - export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
  - echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
  - "./gradlew check jar"
  - docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT .
  - |
    set -e
    if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
      echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
      docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

      git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

      cd helse-iac
      ./set-image.sh preprod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

      git config user.name team-helse[bot]
      git config user.email team-helse[bot]@users.noreply.github.com

      git add preprod/$APP_NAME/naiserator.yaml
      git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

      git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

      cd ..
      fi
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
env:
  global:
    - APP_NAME=pleiepengesoknad-prosessering
    - DOCKER_IMG_NAME=navikt/pleiepengesoknad-prosessering
    - GITHUB_APP_ID=19726
    - secure: T4dXUnKyeQB4BrGMo8odu3dNR9Mxro3f6YmY4TLuE84eNm2qGBEpOXwm1NU1V1/OKR22HefqAh+qQFEZFPHGAfeRQbJpNlH93P9bySOq0zi4nDrppfcbJ79trqX5QGEsvkLwIZaTlNgkvcHiTQSlGTKGvaN9TW6BxL8vsBzziF9RnoaC4GFiC7ESdybN5lQdVPaTwHBwKxtsC5ScqpF1TM83LZlR4ZqzwcdXIKXhkJKX0r8tE7Bnu2RQfe59hNArv/aA6/KGAZd2w5RAUH4DD17BxQLNfeey6k9qkgIRw7opodDxFKXJJL9FUJ2DGI+tcRfEfG4JE9JizrhOKUklYOjCbpFqk6GAY2zfALUGiP03P53hnRnN5pnVTys2iWEXkHVAtSIYOOaAtcPpwC3LCogCG0BZXXLR8PwWIMbhvasoZiR5gmKtfyFIddiMhMO6GdHdnFMGzcWXb6ehEVD3yhzllpXQJPe6spPEz6Lxr+lbQDKbCqHILnlw+mH6AdIFFT4Tbu8bqNKyZvtjV1iNnStYUwyj8ua9nZs5y06oOgckZM+UV5sjGX4/q+9CmzyOFUaY6dEry3v/i1EIserumC8/vKJ0tfu/Iv95dcmnlvBB4iIgEjUI6lq3126+rzJvsQLtDrMpBHHjp+KhfEw9bGP3Xr8KCQxTQS/zwbxrD7c=
    - secure: DQz5hqRWs4cgsa+KyhKu4g13ZY/WxwYRZseeFeSomwo/BLOr6cjlE37EN4BAtNkFV6FqRHTLcQgKtytE19HNkDSi6tPSrmSaht0OqqS5pB6qA91Us6gTxNDzBZu9LSsQNYgpLhB5ymyJrIpjQ6ukhpBRR64W5VKKdkfCO/xXkJ5kFBQrue+50pQMouzymGiAQtGj2gqTDX9uvl11pRaqT35oqbrTwV20+mzrsVcBTVdL21wFY/iHP+SNW9AR8oIztTOPufV3eACZujZq3r9b5RSTvrxiaDF8YRQ8d/s7cv9dvvdmQWoC5xVKPmPjUKD2iwMa7li7AyhIgNaGo8qd2wJ2oOhvj9CWWAd55ChrwgeHQTtSyIE/oYVM6qwVgNaIV4ak99aDJpDPZuLX4gqkgH7fxU/qf6+pkV0JXMdZijwdwU1NHt8PXWYWjt51YsfA1K9hRbCUPITxIb076bSPgiJfxpxltOre2Q+jmqEns8EfDW3m2132AMnrp15CC4uXiWQs9A8TU6mSj+kwrIy9E750dC5byc//DNV0EZeOI+Zd54Qd1e1sVPprPXP1MfA6hiI9KRzfqVej38LuI+POGlE5BtB6pAX45w6Kk0pHV5XRSG8lGQckNMaT+dI3kMfWM1n2fJ+H9ET34Zq+n62ZGwRqu9o0n182oQ63xJwB6Kg=